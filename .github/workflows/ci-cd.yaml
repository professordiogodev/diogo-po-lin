# #name: CI/CD Pipeline

# on:
#   push:
#     branches:
#       - main  # Change this to whatever branch you want to trigger the action

# permissions:
#   id-token: write
#   contents: read

# jobs:
#   build:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v5           # previously v2

#       - name: Configure Azure Credentials
#         uses: azure/login@v2     # previously v1
#         with:
#           auth-type: SERVICE_PRINCIPAL
#           client-id: ${{ secrets.AZURE_CLIENT_ID }}
#           client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
#           tenant-id: ${{ secrets.AZURE_TENANT_ID }}
#           subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
#           enable-AZPSsession: true
# #      - name: Infrastructure build
# #        run: terraform/terraform init
# #             terraform/terraform plan
# #             terraform/terraform apply -auto-approve
# #      - name: Application build
# #        run: backend/npm install
# #             frontend/npm install
# #             frontend/npm run dev
#       # - name: Docker build & push
#       #   run: cd expensy_backend
#       #        docker build -t barberry/ironhack-expensy-backend .
#       #        docker push
#       #        cd ..
#       #        cd expensy_frontend
#       #        docker build -t barberry/ironhack-expensy-frontend .
#       #        frontend/docker push
#       #        cd ..

# #      - name: Install eksctl
# #        run: |
# #          curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
# #          sudo mv /tmp/eksctl /usr/local/bin

#       - name: Update Kubeconfig
# #        run: eksctl utils write-kubeconfig --cluster ironhack-main --region us-east-2
#         run: aws eks update-kubeconfig --name cluster-chinmayee --location "West Europe"

#       - name: Apply Kubernetes Manifests
#         run: kubectl apply -f k8s/


#---------------------------------------------------------------

name: CI/CD Pipeline

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    steps:
      # --------------------------
      # 1. Checkout code
      # --------------------------
      - name: Checkout repository
        uses: actions/checkout@v5

      # --------------------------
      # 2. Login to Azure
      # --------------------------
      # - name: Configure Azure Credentials
      #   uses: azure/login@v2
      #   with:
      #     creds: ${{ secrets.AZURE_CREDENTIALS }}
      #     enable-AzPSSession: true
      - name: Configure Azure Credentials (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}


      # --------------------------
      # 6. Kubernetes
      # --------------------------
      - name: Install kubectl
        run: sudo az aks install-cli

      - name: Update kubeconfig for AKS
        run: |
          az aks get-credentials \
            --resource-group test-k8s \
            --name main-cluster \
            --overwrite-existing

      - name: Apply Kubernetes Manifests
        run: kubectl apply -f k8s/
